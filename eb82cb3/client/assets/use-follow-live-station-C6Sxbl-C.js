import{u as D,k as N,a as k}from"./useQuery-BQpwwpuc.js";import{a as w,m as R,u as Y}from"./amp-client-C2ZZL0mA.js";import{v as F}from"./text-CLqYBJ6O.js";import{u as $,f as z,g as W,a as P,d as B}from"./play-BQDnmloD.js";import{u as Q}from"./useMutation--G9MfniU.js";import{p as b}from"./immer-BQz0PA-9.js";import{l as L}from"./http-error-DJhpcL-Y.js";import{$ as A}from"./index-B6aK0ntB.js";import{d as H}from"./play-DDtWrYBn.js";import{u as X}from"./is-mobile-BqLxbqHZ.js";import{u as Z}from"./useInfiniteQuery-DHZtFi9U.js";import{p as _}from"./slugify-CmQ1Aov3.js";import{G as v,w as j,x as J,y as G,z as h,L as V}from"./request-info-Bv3SWXDS.js";const o={all:["live-stations"],followed:["live-stations","followed"],recs:["live-stations","recs"],one:e=>[...o.all,String(e)],isFollowing:e=>[...o.one(String(e)),"isFollowing"]};function me(e){return D({queryKey:o.isFollowing(e),queryFn:async()=>{const{status:s}=await w.api.v3.profiles.getIsLiveStationFollowed({params:{liveStationId:Number(e)}});return s===204},retry:!1}).data??!1}const E=15;function x({amp:e,time:a,pageParam:s=1}){const i=async()=>{const t=await e.api.v3.profiles.getFollowedLiveStations({query:{limit:E,offset:(s-1)*E},throwOnErrorStatus:!1}).then(({status:r,body:g})=>r===404?{data:[]}:g).then(_("data")).then(r=>r.reduce((g,{liveStationId:y})=>[...g,y],[])),d=await t.reduce(async(r,g)=>{const y=await e.api.v3.livemeta.getStationMeta({params:{stationId:g},throwOnErrorStatus:!1}).then(_("body"));return(await r).push(y),r},Promise.resolve([]));return{liveStations:d,followedStationIds:t,hasNextPage:d.length===E}};return L(a)?a("library-live",i):i()}function we({amp:e}){return Z({queryKey:o.followed,queryFn:({pageParam:a})=>x({amp:e,pageParam:a}),initialPageParam:1,getNextPageParam:(a,s,i)=>a.hasNextPage?i+1:void 0,placeholderData:N,refetchOnMount:!0,staleTime:R("30m"),retry:1})}async function M({amp:e,queryClient:a}){return await a.ensureInfiniteQueryData({queryKey:o.followed,queryFn:({pageParam:s})=>x({amp:e,pageParam:s}),initialPageParam:1,getNextPageParam:(s,i,t)=>s.hasNextPage?t+1:void 0})}const ee=async e=>{const{body:a}=await w.api.v3.livemeta.getStationMeta({params:{stationId:Number(e)}});return a};async function q({stationId:e,queryClient:a}){return await a.ensureQueryData({queryKey:o.one(e),queryFn:async()=>await ee(e)})}function pe({context:e,isOnProfilePage:a=!1,profileStationId:s,stationName:i}){const t=k(),d=Y(),{onInAppMessageExit:r,onInAppMessageOpen:g}=H(),y=$(),O=z(),U=W(),I=X(),C=Q({mutationFn:async({stationId:l,followContext:n})=>{if(d.isAnonymous){const u={trigger:J.FOLLOW,origin:j.LISTEN,pageName:y,location:n??e,...a&&s?{assetId:s.toString()}:{},...a&&i?{assetName:i}:{}},m=O({context:u}),c=U({context:u});B({kind:"info",text:V,onInAppMessageOpen:g,onInAppMessageExit:r,messageType:h.FOLLOW,userTriggered:!0,pageName:y,location:n??e,...a&&s&&i?{globalStation:{id:s.toString(),name:i}}:{},actions:[{kind:"tertiary",size:{mobile:"small",medium:"large"},color:"gray",textColor:F.color.gray600,href:m.toString(),onPress:()=>{r({messageType:h.FOLLOW,exitType:G.CLICK_SUCCESS,pageName:y,location:n??e})},content:"Log in"},{kind:"tertiary",size:{xsmall:"small",medium:"large"},color:"gray",textColor:F.color.gray600,href:c.toString(),onPress:()=>{r({messageType:h.FOLLOW,exitType:G.CLICK_SUCCESS,pageName:y,location:n??e})},content:"Sign up"}]})}else try{const{status:u}=await w.api.v3.profiles.followLiveStation({body:{liveStationId:Number(l)}});return u===204||u===201}catch{return}},onSuccess:async(l,{stationId:n})=>{if(L(l)){const u=I?v.followStationMobile:`${i} ${v.followStationDesktop}`;if(t.setQueryData(o.isFollowing(n),l),L(t.getQueryData(o.followed))){const m=await M({amp:w,queryClient:t}),c=await q({stationId:n,queryClient:t});if(m&&c){await t.cancelQueries({queryKey:o.followed});const p=b(m,S=>{const f=S.pages.at(-1);return f&&(f.liveStations.push(c),f.followedStationIds.push(c.id)),S});t.setQueryData(o.followed,()=>p)}else await t.invalidateQueries({queryKey:o.followed});await t.invalidateQueries({queryKey:o.recs})}P({kind:"success",text:u,actions:location?.pathname!==A("/library/stations/:type",{type:"live"})?[{kind:"tertiary",color:"gray",content:"Go to Library",textColor:F.color.gray600,size:{xsmall:"small",medium:"large"},href:A("/library/stations/:type",{type:"live"})}]:[]})}}}),K=Q({mutationFn:async({stationId:l})=>{try{const{status:n}=await w.api.v3.profiles.unfollowLiveStation({params:{stationId:Number(l)}});return n!==204}catch{return}},onSuccess:async(l,{stationId:n})=>{if(L(l)){const u=I?v.unfollowStationMobile:`${i} ${v.unfollowStationDesktop}`;t.setQueryData(o.isFollowing(n),l);const m=await M({amp:w,queryClient:t}),c=await q({stationId:n,queryClient:t});m&&c?(await t.cancelQueries({queryKey:o.followed}),t.setQueryData(o.followed,p=>p&&b(p,S=>({...S,pages:S?.pages.map(f=>({...f,liveStations:f.liveStations.filter(T=>T.id!==c.id),followedStationIds:f.followedStationIds.filter(T=>T!==c.id)}))})))):await t.invalidateQueries({queryKey:o.followed}),await t.invalidateQueries({queryKey:o.recs}),P({kind:"success",text:u})}}});return{follow:C.mutate,unfollow:K.mutate}}export{pe as a,we as b,o as l,me as u};
//# sourceMappingURL=use-follow-live-station-C6Sxbl-C.js.map
