import{a as b,j as N}from"./create-logger-DNtzi1_a.js";import{c as R,d as I,e as O,M as m}from"./amp-client-C2ZZL0mA.js";import{c as f,l as c,b as y}from"./http-error-DJhpcL-Y.js";import{r as d}from"./chunk-QMGIS6GS-CFDD2jAw.js";import{p as v}from"./slugify-CmQ1Aov3.js";import{d as u}from"./use-item-selected-BbUZv3TT.js";import{u as j}from"./request-info-Bv3SWXDS.js";import{l as A}from"./use-apps-flyer-CIIIQYDX.js";function P(t){try{return I.parse(JSON.parse(decodeURIComponent(atob(t))))}catch{return{market:void 0,geoMarket:void 0}}}function g(t){try{return btoa(encodeURIComponent(JSON.stringify(t)))}catch{return}}function G(t,e){const{type:s,payload:a}=e;switch(s){case"updateGeoMarket":{const r=u(t);r.geoMarket=a;const{geoMarket:i,market:o}=r,n=g({geoMarket:i,market:o});return n&&f.set(m,n),r}case"updateMarket":{const r=u(t);fetch("/api/v1/set-market",{method:"POST",body:JSON.stringify({marketId:a.marketId}),headers:{"Content-Type":"application/json"}}),r.market=a;const{market:i,geoMarket:o}=r,n=g({geoMarket:o,market:i});return n&&f.set(m,n),r}case"ready":{const r=u(t);r.ready=a;const{market:i,geoMarket:o}=r,n=g({geoMarket:o,market:i});return n&&f.set(m,n,{secure:!0,sameSite:"none"}),r}case"fetchedMarket":{const r={...u(t),ready:!0};return S(r,a),r}case"batch":{const r=u(t);for(const[i,o]of Object.entries(a))switch(i){case"updateMarket":{r.market=o;break}case"updateGeoMarket":{r.geoMarket=o;break}case"fetchedMarket":{S(r,o),r.ready=!0;break}}return r}}}function S(t,e){y(t.market)&&(t.market=e),y(t.geoMarket)&&(t.geoMarket=e);const{market:s,geoMarket:a}=t,r=g({geoMarket:a,market:s});r&&f.set(m,r,{secure:!0,sameSite:"none"})}function C(t){return c(t)&&!Number.isNaN(Number(t))}function J({lat:t,lng:e}){return C(t)&&C(e)?{lat:t,lng:e}:{useIP:!0}}async function T({coords:t={lat:void 0,lng:void 0},dispatch:e,fatalStop:s,getMarkets:a,onlyGeo:r}){const{lat:i,lng:o}=t;try{const n=await a({query:{...J({lat:i,lng:o}),limit:1},fetchOptions:{cache:"no-store"}}).then(v("body")).then(v("hits")).then(k=>k?.at(0));if(n)e(r?{type:"updateGeoMarket",payload:n}:{type:"fetchedMarket",payload:n});else throw new Error("Failed to fetch geo market")}catch(n){s.current=!0,A.warn(n instanceof Error?n.message:"Unknown error"),e({type:"ready",payload:!0})}}function U(){const t={market:void 0,geoMarket:void 0,ready:!1},e=f.get(m);if(e){const s=P(e);c(s.market)&&(t.market=s.market),c(s.geoMarket)&&(t.geoMarket=s.geoMarket)}return c(t.market)&&c(t.geoMarket)&&(t.ready=!0),t}const x=d.createContext(null);function z(t){const e=b.c(11),{children:s}=t,{geo:a}=j(),r=O(),i=d.useRef(!1),[o,n]=d.useReducer(G,null,U);let k,p;e[0]!==r.api.v2.content.getMarkets||e[1]!==a||e[2]!==o.geoMarket||e[3]!==o.market?(k=()=>{if(y(o.geoMarket)||y(o.market)){const{lat:w,lng:E}=a??{};i.current||T({fatalStop:i,getMarkets:r.api.v2.content.getMarkets,onlyGeo:c(o.geoMarket)&&c(o.market),coords:{lat:w,lng:E},dispatch:n})}},p=[o.geoMarket,o.market,n,a,r.api.v2.content.getMarkets],e[0]=r.api.v2.content.getMarkets,e[1]=a,e[2]=o.geoMarket,e[3]=o.market,e[4]=k,e[5]=p):(k=e[4],p=e[5]),d.useEffect(k,p);let M;e[6]!==o?(M=[o,n],e[6]=o,e[7]=M):M=e[7];const h=M;let l;return e[8]!==s||e[9]!==h?(l=N.jsx(x.Provider,{value:h,children:s}),e[8]=s,e[9]=h,e[10]=l):l=e[10],l}function B(){const t=b.c(3),e=d.useContext(x);R(e,"Attempted to use MarketContext outside of MarketContext.Provider");const[s,a]=e;let r;return t[0]!==a||t[1]!==s?(r={...s,setMarket(i){a({type:"updateMarket",payload:i})}},t[0]=a,t[1]=s,t[2]=r):r=t[2],r}export{z as M,P as p,B as u};
//# sourceMappingURL=market-_UCjo8N6.js.map
