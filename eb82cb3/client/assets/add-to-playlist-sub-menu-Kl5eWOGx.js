import{a as re,j as p}from"./create-logger-DNtzi1_a.js";import{v as O,B as N,l as ae,_ as V,L as ne,F as ce}from"./text-CLqYBJ6O.js";import{a as de,b as ue}from"./dialog-BOgHZT5V.js";import{u as me,M as X,_ as pe}from"./text-field-D1WHOBrX.js";import{r as S,a as le,f as ye}from"./chunk-QMGIS6GS-CFDD2jAw.js";import{a as D,u as fe,f as ge,g as be,d as he}from"./play-BQDnmloD.js";import{a as oe}from"./useQuery-BQpwwpuc.js";import{u as K}from"./useMutation--G9MfniU.js";import{p as k}from"./slugify-CmQ1Aov3.js";import{l as U,h as Te,o as G,s as j,a as xe,g as z,n as Q,i as Ie}from"./http-error-DJhpcL-Y.js";import{u as B,e as H}from"./amp-client-C2ZZL0mA.js";import{f as Y}from"./urls-o6i5CSG-.js";import{p as M}from"./constants-Culc7LLS.js";import{I as J,y as Z,z as W,h as _,L as Ce,w as ee,x as te,P as ve}from"./request-info-Bv3SWXDS.js";import{M as R,b as ke,c as Se}from"./ellipsis-horizontal-DiyQgcWZ.js";import{P as Pe}from"./playlist-SwzaceOD.js";import{n as we}from"./chunk-VCYTMP4D-Dtug6Gx1.js";import{P as Ee}from"./plus-Da1SglIs.js";import{$ as Ae}from"./index-B6aK0ntB.js";import{d as Me,i as $e}from"./play-DDtWrYBn.js";import{a as Le}from"./use-query-playlist-92VoC3Yg.js";import{a as je}from"./useListData-CNxJNYqp.js";import{x as Ue,J as De}from"./create-analytics-DYSkN0SF.js";function Fe(t,e){let r;switch(t.state){case"idle":case"error":switch(e.type){case"loading":case"loadingMore":case"sorting":case"filtering":var a,b;return{...t,filterText:(a=e.filterText)!==null&&a!==void 0?a:t.filterText,state:e.type,items:e.type==="loading"?[]:t.items,sortDescriptor:(b=e.sortDescriptor)!==null&&b!==void 0?b:t.sortDescriptor,abortController:e.abortController};case"update":var u;return{...t,...(u=e.updater)===null||u===void 0?void 0:u.call(e,t)};case"success":case"error":return t;default:throw new Error(`Invalid action "${e.type}" in state "${t.state}"`)}case"loading":case"sorting":case"filtering":switch(e.type){case"success":if(e.abortController!==t.abortController)return t;var g;r=(g=e.selectedKeys)!==null&&g!==void 0?g:t.selectedKeys;var l,o,m;return{...t,filterText:(l=e.filterText)!==null&&l!==void 0?l:t.filterText,state:"idle",items:[...(o=e.items)!==null&&o!==void 0?o:[]],selectedKeys:r==="all"?"all":new Set(r),sortDescriptor:(m=e.sortDescriptor)!==null&&m!==void 0?m:t.sortDescriptor,abortController:void 0,cursor:e.cursor};case"error":return e.abortController!==t.abortController?t:{...t,state:"error",error:e.error,abortController:void 0};case"loading":case"loadingMore":case"sorting":case"filtering":var v;(v=t.abortController)===null||v===void 0||v.abort();var d;return{...t,filterText:(d=e.filterText)!==null&&d!==void 0?d:t.filterText,state:e.type,items:e.type==="loading"?[]:t.items,abortController:e.abortController};case"update":var I;return{...t,...(I=e.updater)===null||I===void 0?void 0:I.call(e,t)};default:throw new Error(`Invalid action "${e.type}" in state "${t.state}"`)}case"loadingMore":switch(e.type){case"success":var h;r=t.selectedKeys==="all"||e.selectedKeys==="all"?"all":new Set([...t.selectedKeys,...(h=e.selectedKeys)!==null&&h!==void 0?h:[]]);var T,C;return{...t,state:"idle",items:[...t.items,...(T=e.items)!==null&&T!==void 0?T:[]],selectedKeys:r,sortDescriptor:(C=e.sortDescriptor)!==null&&C!==void 0?C:t.sortDescriptor,abortController:void 0,cursor:e.cursor};case"error":return e.abortController!==t.abortController?t:{...t,state:"error",error:e.error};case"loading":case"sorting":case"filtering":var n;(n=t.abortController)===null||n===void 0||n.abort();var c;return{...t,filterText:(c=e.filterText)!==null&&c!==void 0?c:t.filterText,state:e.type,items:e.type==="loading"?[]:t.items,abortController:e.abortController};case"loadingMore":var x;return(x=e.abortController)===null||x===void 0||x.abort(),t;case"update":var s;return{...t,...(s=e.updater)===null||s===void 0?void 0:s.call(e,t)};default:throw new Error(`Invalid action "${e.type}" in state "${t.state}"`)}default:throw new Error(`Invalid state "${t.state}"`)}}function Ke(t){const{load:e,sort:r,initialSelectedKeys:a,initialSortDescriptor:b,getKey:u=d=>d.id||d.key,initialFilterText:g=""}=t;let[l,o]=S.useReducer(Fe,{state:"idle",error:void 0,items:[],selectedKeys:a==="all"?"all":new Set(a),sortDescriptor:b,filterText:g});const m=async(d,I)=>{let h=new AbortController;try{o({...d,abortController:h});var T;let c=(T=d.filterText)!==null&&T!==void 0?T:l.filterText;var C;let x=await I({items:l.items.slice(),selectedKeys:l.selectedKeys,sortDescriptor:(C=d.sortDescriptor)!==null&&C!==void 0?C:l.sortDescriptor,signal:h.signal,cursor:d.type==="loadingMore"?l.cursor:void 0,filterText:c,loadingState:l.state});var n;let s=(n=x.filterText)!==null&&n!==void 0?n:c;o({type:"success",...x,abortController:h}),s&&s!==c&&!h.signal.aborted&&m({type:"filtering",filterText:s},e)}catch(c){o({type:"error",error:c,abortController:h})}};let v=S.useRef(!1);return S.useEffect(()=>{v.current||(m({type:"loading"},e),v.current=!0)},[]),{items:l.items,selectedKeys:l.selectedKeys,sortDescriptor:l.sortDescriptor,isLoading:l.state==="loading"||l.state==="loadingMore"||l.state==="sorting"||l.state==="filtering",loadingState:l.state,error:l.error,filterText:l.filterText,getItem(d){return l.items.find(I=>u(I)===d)},reload(){m({type:"loading"},e)},loadMore(){l.state==="loading"||l.state==="loadingMore"||l.state==="filtering"||l.cursor==null||m({type:"loadingMore"},e)},sort(d){m({type:"sorting",sortDescriptor:d},r||e)},...je({...t,getKey:u,cursor:l.cursor},d=>{o({type:"update",updater:d})}),setFilterText(d){m({type:"filtering",filterText:d},e)}}}class q extends Error{ctx;meta;constructor(e){super("User is anonymous"),this.ctx=e,this.meta=new Map}addMeta(e,r){this.meta.set(e,r)}getMeta(e){return this.meta.get(e)}}function Oe(){const t=oe(),e=B(),r=le(),a=H(),b=S.useCallback(async({name:g,tracks:l=[],albumId:o})=>{const m=U(o)?await a.api.v3.catalog.getAlbum({params:{id:o}}).then(k("body")).then(k("tracks")).then(v=>v.map(d=>d.id)):l;return await a.api.v3.collection.postCreateCollection({params:{userId:e.profileId},body:{name:g,tracks:m}}).then(k("body")).then(k("data"))},[a.api.v3.catalog,a.api.v3.collection,e.profileId]),u=S.useCallback(async g=>{U(g)&&(t.setQueryData(M.isFollowing({id:g.id,userId:String(e.profileId)}),!0),t.invalidateQueries({queryKey:M.followed}),t.invalidateQueries({queryKey:M.recs}),D({kind:"success",text:"Playlist created",actions:[{kind:"tertiary",color:"gray",content:"Go to playlist",size:"large",textColor:O.color.gray600,onPress:()=>{const l=Y(g);l&&r(l)}}]}))},[r,t,e.profileId]);return K({mutationFn:b,onSuccess:u})}function Re({albumId:t,tracks:e}){return{albumId:t,tracks:e,name:""}}function Ne(t,e){switch(e.type){case"updateName":{const{name:r}=e.payload;return{...t,name:r}}}}const ft=t=>{const e=re.c(39),{albumId:r,tracks:a}=t;let b;e[0]!==r||e[1]!==a?(b={albumId:r,tracks:a},e[0]=r,e[1]=a,e[2]=b):b=e[2];const[u,g]=S.useReducer(Ne,b,Re),{mutate:l,error:o,isError:m,isIdle:v,isPending:d,isSuccess:I}=Oe(),h=me();let T,C;e[3]!==h||e[4]!==I?(T=()=>{I&&h.dismiss()},C=[I,h],e[3]=h,e[4]=I,e[5]=T,e[6]=C):(T=e[5],C=e[6]),S.useEffect(T,C);let n;e[7]===Symbol.for("react.memo_cache_sentinel")?(n=p.jsx(N,{asChild:!0,color:ae("$gray600","$brandWhite"),children:p.jsx(de,{children:"Create New Playlist"})}),e[7]=n):n=e[7];let c;e[8]===Symbol.for("react.memo_cache_sentinel")?(c=p.jsx(pe,{isRequired:!0,label:"Playlist Name",maxLength:J,name:"name",onChange:ie=>{g({type:"updateName",payload:{name:ie}})},placeholder:"Enter playlist name"}),e[8]=c):c=e[8];let x;e[9]!==u.name.length?(x=p.jsxs(N,{children:[c,p.jsxs(X,{kind:"neutral",children:[u.name.length," / ",J]})]}),e[9]=u.name.length,e[10]=x):x=e[10];let s;e[11]!==o||e[12]!==m?(s=m?p.jsx(X,{kind:"error",children:o.message},o.message):null,e[11]=o,e[12]=m,e[13]=s):s=e[13];let i;e[14]!==h?(i=()=>h.dismiss(),e[14]=h,e[15]=i):i=e[15];let y;e[16]===Symbol.for("react.memo_cache_sentinel")?(y={mobile:"small",medium:"large"},e[16]=y):y=e[16];let f;e[17]!==i?(f=p.jsx(V,{color:"default",inline:!0,kind:"secondary",onPress:i,size:y,type:"reset",children:"Cancel"}),e[17]=i,e[18]=f):f=e[18];let P;e[19]!==d||e[20]!==u.name?(P=d||u.name.trim().length===0,e[19]=d,e[20]=u.name,e[21]=P):P=e[21];let w;e[22]!==l||e[23]!==u?(w=()=>{l(u)},e[22]=l,e[23]=u,e[24]=w):w=e[24];let E;e[25]===Symbol.for("react.memo_cache_sentinel")?(E={xsmall:"small",medium:"large"},e[25]=E):E=e[25];let A;e[26]!==v?(A=v?"Create playlist":p.jsx(ne,{size:16}),e[26]=v,e[27]=A):A=e[27];let $;e[28]!==P||e[29]!==w||e[30]!==A?($=p.jsx(V,{color:"red",inline:!0,isDisabled:P,kind:"primary",onPress:w,size:E,type:"submit",children:A}),e[28]=P,e[29]=w,e[30]=A,e[31]=$):$=e[31];let L;e[32]!==f||e[33]!==$?(L=p.jsxs(N,{alignItems:"center",display:"flex",flexDirection:"row",gap:"$16",justifyContent:"center",children:[f,$]}),e[32]=f,e[33]=$,e[34]=L):L=e[34];let F;return e[35]!==L||e[36]!==x||e[37]!==s?(F=p.jsx(ue,{children:p.jsxs(ce,{flexDirection:"column",gap:"$16",children:[n,x,s,L]})}),e[35]=L,e[36]=x,e[37]=s,e[38]=F):F=e[38],F},Ge=Te("intent",[G({intent:z("byTracks"),tracks:xe(Q()),collectionId:j()}),G({intent:z("byAlbum"),albumId:Q(),collectionId:j()}),G({intent:z("byCollection"),collectionId:j(),sourceCollectionId:j(),playlistUserId:Ie([j(),Q()])})]);function ze(t){const e=oe(),r=B(),a=fe(),b=ge(),u=be(),{onInAppMessageExit:g,onInAppMessageOpen:l}=Me(),o=H(),m=S.useCallback(async s=>{if(s instanceof q){const i=s.ctx,y=b({context:i}),f=u({context:i});he({kind:"info",text:Ce,onInAppMessageOpen:l,onInAppMessageExit:g,messageType:W.FOLLOW,userTriggered:!0,pageName:a,location:_.OVERFLOW_MENU,actions:[{kind:"tertiary",size:{mobile:"small",medium:"large"},color:"gray",textColor:O.color.gray600,href:y.toString(),onPress:()=>{g({messageType:W.FOLLOW,exitType:Z.CLICK_SUCCESS,pageName:a})},content:"Log in"},{kind:"tertiary",size:{xsmall:"small",medium:"large"},color:"gray",textColor:O.color.gray600,href:f.toString(),onPress:()=>{g({messageType:W.FOLLOW,exitType:Z.CLICK_SUCCESS,pageName:a})},content:"Sign up"}]})}else D({text:s.message,kind:"error"});t?.onError?.(s)},[b,u,g,l,a,t]),v=S.useCallback(async s=>{const i=Ge.parse(s);switch(i.intent){case"byTracks":{const{collectionId:y,tracks:f}=i;return o.api.v3.collection.addTracksToCollection({params:{id:y,userId:r.profileId},body:{tracks:f}}).then(k("body")).then(k("data"))}case"byAlbum":{const{collectionId:y,albumId:f}=i,P=await o.api.v3.catalog.getAlbum({params:{id:f}}).then(k("body")).then(k("tracks")).then(w=>w.map(E=>E.id));return o.api.v3.collection.addTracksToCollection({params:{id:y,userId:r.profileId},body:{tracks:P}}).then(k("body")).then(k("data"))}case"byCollection":{const{collectionId:y,sourceCollectionId:f,playlistUserId:P}=i,w=await o.api.v3.collection.getCollection({params:{id:f,userId:P}}).then(k("body")).then(k("tracks")).then(E=>E.map(A=>A.trackId));return o.api.v3.collection.addTracksToCollection({params:{id:y,userId:r.profileId},body:{tracks:$e(r)?w:[...new Set(w)]}}).then(k("body")).then(k("data"))}}},[o.api.v3.catalog,o.api.v3.collection,r]),d=S.useCallback(async s=>{s&&s.id&&(e.setQueryData(M.one({id:s.id,userId:String(r.profileId)}),i=>{if(i){const y=new Set([...i.tracks.map(f=>f.trackId),...s.tracks.map(f=>f.trackId)]);return{...i,tracks:s.tracks,backfillTracks:[...i.backfillTracks??[],...s.backfillTracks??[]].filter(f=>!y.has(f)).slice(0,8)}}}),t?.onSuccess?.(s))},[t,e,r.profileId]),I=K({mutationFn:v,onSuccess:d,onError:m}),h=S.useCallback(async({collectionId:s,name:i})=>{if(r.isAnonymous)throw new q({trigger:te.FOLLOW,origin:ee.LISTEN,pageName:a});return o.api.v3.collection.putUpdateCollection({params:{userId:r.profileId,id:s},body:{name:i}}).then(k("body")).then(k("data"))},[o.api.v3.collection,r.isAnonymous,r.profileId,a]),T=S.useCallback(async s=>{if(s&&s.id&&(e.invalidateQueries({queryKey:M.followed}),e.setQueryData(M.one({id:s.id,userId:String(r.profileId)}),i=>{if(i)return{...i,...s}}),globalThis.window)){const i=new URL(globalThis.window.location.href);i.pathname.includes(s.id)&&(i.pathname=Ae("/playlist/:playlistSlug",{playlistSlug:`${s.slug}-${s.userId}-${s.id}`}),globalThis.window.history.replaceState(null,"",i))}},[e,r.profileId]),C=K({mutationFn:h,onError:m,onSuccess:T}),n=S.useCallback(async({collectionId:s,trackIds:i})=>{if(r?.isAnonymous)throw new q({trigger:te.FOLLOW,origin:ee.LISTEN,pageName:a,location:_.OVERFLOW_MENU});return await o.api.v3.collection.removeTracksFromCollection({params:{id:s,userId:r.profileId},body:{tracks:i}}),i},[o.api.v3.collection,a,r?.isAnonymous,r.profileId]),c=S.useCallback(async(s,{collectionId:i})=>{e.setQueryData(M.one({id:i,userId:r.profileId}),y=>{if(y&&s)return D({kind:"success",text:"Removed from Playlist"}),{...y,tracks:y.tracks.filter(f=>!s.includes(f.id))}})},[e,r.profileId]),x=K({mutationFn:n,onSuccess:c,onError:m});return{rename:C,addToPlaylist:I,removeFromPlaylist:x}}const se=t=>{const{albumId:e,playlistId:r,setDialog:a,tracks:b,playlistUserId:u,setPlaylistTracks:g,row:l}=t,o=le(),m=ye(),v=Le({id:r,userId:u}),d=S.useCallback(n=>{const c=Y(n),x=U(c)&&c!==m.pathname;D({kind:"success",text:`Added to ${n.name}`,...x?{actions:[{kind:"tertiary",color:"gray",content:"Go to playlist",size:"large",textColor:O.color.gray600,onPress:()=>{const s=Y(n);s&&o(s)}}]}:{}}),a?.(null)},[o,a,m.pathname]),I=S.useCallback(n=>{D({kind:"error",title:"Error adding to playlist",text:n.message}),a?.(null)},[a]),{addToPlaylist:h}=ze({onError:I,onSuccess:d}),{mutate:T}=h,C=S.useCallback(({collectionId:n})=>{const c=(b?.length??0)>0?"byTracks":U(e)?"byAlbum":U(r)?"byCollection":void 0;if(c)switch(c){case"byTracks":return T({intent:c,tracks:b,collectionId:n});case"byAlbum":return T({intent:c,albumId:e,collectionId:n});case"byCollection":return T({intent:c,sourceCollectionId:r,collectionId:n,playlistUserId:u})}},[T,e,r,b,u]);return p.jsx(p.Fragment,{children:l.type==="create-playlist"?p.jsxs(p.Fragment,{children:[p.jsxs(R,{"data-test":"create-playlist-menu-item",onAction:()=>{const n=v?.data?.tracks.map(c=>c.trackId)??[];a(ve.Create),g?.(n)},children:[p.jsx(Ee,{}),"Create new playlist"]}),p.jsx(ke,{})]}):l.type==="playlist"?p.jsx(R,{"data-test":"playlist-menu-item",onAction:()=>{C({collectionId:l.data.id})},children:l.data.name}):null})},Qe=async({userId:t,cursor:e,signal:r,amp:a})=>await a.api.v3.collection.getCollections({params:{userId:t},query:{includePersonalized:!1,playlistFilter:"created",...e?{pageKey:e}:{}},fetchOptions:{signal:r}}).then(k("body")),gt=t=>{const e=re.c(32),{albumId:r,icon:a,playlistId:b,setDialog:u,tracks:g,triggerText:l,playlistUserId:o,setPlaylistTracks:m}=t,v=B(),d=H();let I;e[0]!==d||e[1]!==v?(I={async load(y){const{signal:f,cursor:P}=y,{data:w,links:E}=await Qe({userId:String(v.profileId),signal:f,cursor:P,amp:d});return{items:w.filter(We)??[],cursor:E?.nextPageKey}}},e[0]=d,e[1]=v,e[2]=I):I=e[2];const h=Ke(I);let T;e[3]===Symbol.for("react.memo_cache_sentinel")?(T={type:"create-playlist",id:"create-playlist"},e[3]=T):T=e[3];let C;e[4]!==h.items?(C=[T,...h.items.map(qe)],e[4]=h.items,e[5]=C):C=e[5];const n=C;if(we(l)){let y;e[6]!==r||e[7]!==n||e[8]!==b||e[9]!==o||e[10]!==u||e[11]!==m||e[12]!==g?(y=n.length>1?n.map(P=>p.jsx(se,{albumId:r,playlistId:b,playlistUserId:o,row:P,setDialog:u,setPlaylistTracks:m,tracks:g},P.id)):null,e[6]=r,e[7]=n,e[8]=b,e[9]=o,e[10]=u,e[11]=m,e[12]=g,e[13]=y):y=e[13];let f;return e[14]!==y?(f=p.jsx(p.Fragment,{children:y}),e[14]=y,e[15]=f):f=e[15],f}let c;e[16]!==a||e[17]!==l?(c=a?p.jsxs(R,{children:[p.jsx(Pe,{size:18})," ",l]}):p.jsx(R,{children:l}),e[16]=a,e[17]=l,e[18]=c):c=e[18];let x;e[19]!==r||e[20]!==b||e[21]!==o||e[22]!==u||e[23]!==m||e[24]!==g?(x=y=>p.jsx(se,{albumId:r,playlistId:b,playlistUserId:o,row:y,setDialog:u,setPlaylistTracks:m,tracks:g}),e[19]=r,e[20]=b,e[21]=o,e[22]=u,e[23]=m,e[24]=g,e[25]=x):x=e[25];let s;e[26]!==n||e[27]!==x?(s=p.jsx(Ue,{children:p.jsx(Se,{items:n,children:x})}),e[26]=n,e[27]=x,e[28]=s):s=e[28];let i;return e[29]!==c||e[30]!==s?(i=p.jsxs(De,{"data-test":"add-to-playlist-sub-menu",children:[c,s]}),e[29]=c,e[30]=s,e[31]=i):i=e[31],i};function We(t){return t.id!=="new4u"}function qe(t,e){return{type:"playlist",data:t,id:`playlist-${t.id}`,index:e}}export{gt as A,ft as C,q as R,ze as u};
//# sourceMappingURL=add-to-playlist-sub-menu-Kl5eWOGx.js.map
