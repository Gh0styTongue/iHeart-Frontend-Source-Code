import{v as h}from"./text-CLqYBJ6O.js";import{u as K,f as k,g as R,a as L,d as Y}from"./play-BQDnmloD.js";import{k as $,a as z,u as W}from"./useQuery-BQpwwpuc.js";import{u as Q}from"./useMutation--G9MfniU.js";import{p as v}from"./immer-BQz0PA-9.js";import{l as T}from"./http-error-DJhpcL-Y.js";import{$ as _}from"./index-B6aK0ntB.js";import{d as B}from"./play-DDtWrYBn.js";import{a as f,m as H,u as X}from"./amp-client-C2ZZL0mA.js";import{u as Z}from"./is-mobile-BqLxbqHZ.js";import{p as G}from"./slugify-CmQ1Aov3.js";import{a as r}from"./constants-BDU6E-IP.js";import{u as j}from"./useInfiniteQuery-DHZtFi9U.js";import{G as I,w as J,x as V,y as q,z as F,L as tt}from"./request-info-Bv3SWXDS.js";const et=async t=>{const{body:e}=await f.api.v3.artists.getArtistProfile({params:{id:t}});return e};async function x({artistId:t,queryClient:e}){return await e.ensureQueryData({queryKey:r.one(t),queryFn:async()=>await et(t)})}const st=async({artistId:t,profileId:e})=>await f.api.v2.playlists.getStationBySeedId({params:{seedId:t,type:"ARTIST",profileId:e}}).then(G("body")).then(G("value"));async function at({artistId:t,profileId:e,queryClient:a}){return await a.ensureQueryData({queryKey:r.station(t),queryFn:()=>st({artistId:Number(t),profileId:e})})}const P=15;function M({amp:t,pageParam:e=1,time:a}){const i=async()=>{let s=!0;const w=await t.api.v3.profiles.getFollowedArtists({query:{limit:P,offset:(e-1)*P},throwOnErrorStatus:!1}).then(({status:l,body:A})=>l===404?{data:[]}:A).then(({data:l})=>(l.length<P&&(s=!1),l)).then(l=>l.filter(A=>A.artistSeed));return{followedArtists:w,hasNextPage:w.length>0?s:!1}};return T(a)?a("library-artist",i):i()}function At({amp:t}){return j({queryKey:r.followed,queryFn:({pageParam:e})=>M({amp:t,pageParam:e}),initialPageParam:1,getNextPageParam:(e,a,i)=>e.hasNextPage?i+1:void 0,placeholderData:$,staleTime:H("30m"),refetchOnMount:!0,retry:1})}async function D({amp:t,queryClient:e}){return await e.ensureInfiniteQueryData({queryKey:r.followed,queryFn:({pageParam:a})=>M({amp:t,pageParam:a}),initialPageParam:1,getNextPageParam:(a,i,s)=>a.hasNextPage?s+1:void 0})}function St({context:t,isOnProfilePage:e=!1,stationId:a,stationName:i}){const s=z(),w=X(),{onInAppMessageExit:l,onInAppMessageOpen:A}=B(),S=K(),N=k(),O=R(),E=Z(),U=Q({mutationFn:async({artistId:n,followContext:o})=>{const g={trigger:V.FOLLOW,origin:J.LISTEN,pageName:S,location:o??t,...e&&a?{assetId:a.toString()}:{},...e&&i?{assetName:i}:{}},m=N({context:g}),u=O({context:g});if(w.isAnonymous)Y({kind:"info",text:tt,onInAppMessageOpen:A,onInAppMessageExit:l,messageType:F.FOLLOW,userTriggered:!0,pageName:S,location:o??t,...e&&a&&i?{globalStation:{id:a.toString(),name:i}}:{},actions:[{kind:"tertiary",size:{mobile:"small",medium:"large"},color:"gray",textColor:h.color.gray600,href:m.toString(),onPress:()=>{l({messageType:F.FOLLOW,exitType:q.CLICK_SUCCESS,pageName:S,location:o??t})},content:"Log in"},{kind:"tertiary",size:{xsmall:"small",medium:"large"},color:"gray",textColor:h.color.gray600,href:u.toString(),onPress:()=>{l({messageType:F.FOLLOW,exitType:q.CLICK_SUCCESS,pageName:S,location:o??t})},content:"Sign up"}]});else try{const{status:c,body:y}=await f.api.v3.profiles.followArtist({body:{artistId:Number(n)}}),p=c===204||c===201,d=y?.stationId;return{success:p,stationId:d}}catch{return{success:!1,stationId:void 0}}},onSuccess:async(n,{artistId:o})=>{if(T(n)&&n.success){const g=E?I.followStationMobile:`${i} ${I.followStationDesktop}`;if(s.setQueryData(r.isFollowing(o),n),T(s.getQueryData(r.followed))){const m=await D({amp:f,queryClient:s}),u=await x({artistId:o,queryClient:s}),c=await at({artistId:o,queryClient:s,profileId:w.profileId}),y=n.stationId??c.id;if(m&&u&&y){const p=v(m,d=>{const b=d.pages.at(-1);return b&&b.followedArtists.push({stationId:y,name:u.artist.name,artistName:u.artist.name,artistSeed:u.artist.artistId,lastPlayed:c.lastPlayed}),d});s.setQueryData(r.followed,()=>p)}else await s.invalidateQueries({queryKey:r.followed});await s.invalidateQueries({queryKey:r.recs})}L({kind:"success",text:g,actions:location?.pathname!==_("/library/stations/:type",{type:"artists"})?[{kind:"tertiary",color:"gray",content:"Go to Library",textColor:h.color.gray600,size:{xsmall:"small",medium:"large"},href:_("/library/stations/:type",{type:"artists"})}]:[]})}}}),C=Q({mutationFn:async({artistId:n})=>{try{const{status:o}=await f.api.v3.profiles.unfollowArtist({params:{artistId:Number(n)}});return o!==204}catch{return}},onSuccess:async(n,{artistId:o})=>{if(T(n)){const g=E?I.unfollowStationMobile:`${i} ${I.unfollowStationDesktop}`;s.setQueryData(r.isFollowing(o),n);const m=await D({amp:f,queryClient:s}),u=await x({artistId:o,queryClient:s});m&&u?s.setQueryData(r.followed,c=>c&&v(c,y=>({...y,pages:y?.pages.map(p=>({...p,followedArtists:p.followedArtists.filter(d=>d.artistSeed!==u.artist.artistId)}))}))):await s.invalidateQueries({queryKey:r.followed}),await s.invalidateQueries({queryKey:r.recs}),L({kind:"success",text:g})}}});return{follow:U.mutate,unfollow:C.mutate}}function It(t){return W({queryKey:r.isFollowing(t),queryFn:async()=>{const{status:a}=await f.api.v3.profiles.getIsArtistFollowed({params:{artistId:Number(t)}});return a===204},retry:!1}).data??!1}export{St as a,At as b,It as u};
//# sourceMappingURL=use-following-artist-CeQ31TSZ.js.map
