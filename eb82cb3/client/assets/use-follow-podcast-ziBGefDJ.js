import{u as q,k as N,a as M}from"./useQuery-BQpwwpuc.js";import{a as m,m as R,u as k}from"./amp-client-C2ZZL0mA.js";import{p as t}from"./constants-BUXPhHxG.js";import{v as w}from"./text-CLqYBJ6O.js";import{u as Y,f as z,g as W,a as x,d as $}from"./play-BQDnmloD.js";import{u as E}from"./useMutation--G9MfniU.js";import{p as F}from"./immer-BQz0PA-9.js";import{b as L,l as P}from"./http-error-DJhpcL-Y.js";import{$ as A}from"./index-B6aK0ntB.js";import{d as B}from"./play-DDtWrYBn.js";import{u as H}from"./is-mobile-BqLxbqHZ.js";import{u as X}from"./useInfiniteQuery-DHZtFi9U.js";import{p as Z}from"./slugify-CmQ1Aov3.js";import{g as C}from"./use-query-podcast-BOqyFvD5.js";import{w as j,x as J,y as Q,z as S,L as V}from"./request-info-Bv3SWXDS.js";function me(a){return q({queryKey:t.isFollowing(a),queryFn:async()=>{const{status:s}=await m.api.v3.podcast.getIsFollowingPodcast({params:{podcastId:Number(a)}});return s===200}}).data??!1}const v=20;function I({pages:a,pageParam:o}){const s=L(o)?(a??1)*v:v;return m.api.v3.podcast.getPodcastFollows({query:{limit:s,...o?{pageKey:o}:{},sortBy:"TITLE",sortOrder:"ASC",withNewEpisodeCounts:!0}}).then(Z("body")).then(({data:i,links:e})=>({podcasts:i,hasNextPage:!L(e.next),pageKey:e.next}))}function fe(a){return X({queryKey:t.followed,queryFn:({pageParam:o})=>I({pageParam:o,pages:a}),initialPageParam:void 0,getNextPageParam:o=>o.hasNextPage?o.pageKey:void 0,staleTime:R("2s"),placeholderData:N})}async function G({pages:a,queryClient:o}){return await o.ensureInfiniteQueryData({queryKey:t.followed,queryFn:({pageParam:s})=>I({pages:a,pageParam:s}),initialPageParam:void 0,getNextPageParam:s=>s.hasNextPage?s.pageKey:void 0})}function we({context:a,isOnProfilePage:o=!1,stationId:s,stationName:i}){const e=M(),_=k(),{onInAppMessageExit:f,onInAppMessageOpen:h}=B(),d=Y(),U=z(),K=W(),T=H(),b=E({mutationFn:async({podcastId:r,followContext:n})=>{if(_.isAnonymous){const l={trigger:J.FOLLOW,origin:j.LISTEN,pageName:d,location:a,...o&&s?{assetId:s.toString()}:{},...o&&i?{assetName:i}:{}},u=U({context:l}),c=K({context:l});$({kind:"info",text:V,onInAppMessageOpen:h,onInAppMessageExit:f,messageType:S.FOLLOW,userTriggered:!0,pageName:d,location:n??a,...o&&s&&i?{globalStation:{id:s.toString(),name:i}}:{},actions:[{kind:"tertiary",size:{mobile:"small",medium:"large"},color:"gray",textColor:w.color.gray600,href:u.toString(),onPress:()=>{f({messageType:S.FOLLOW,exitType:Q.CLICK_SUCCESS,pageName:d})},content:"Log in"},{kind:"tertiary",size:{xsmall:"small",medium:"large"},color:"gray",textColor:w.color.gray600,href:c.toString(),onPress:()=>{f({messageType:S.FOLLOW,exitType:Q.CLICK_SUCCESS,pageName:d})},content:"Sign up"}]})}else try{const{status:l}=await m.api.v3.podcast.followPodcast({params:{podcastId:Number(r)}});return l===204}catch{return}},onSuccess:async(r,{podcastId:n})=>{if(P(r)){e.setQueryData(t.isFollowing(n),r);const l=T?"Following podcast":`Following ${i}`;if(P(e.getQueryData(t.followed))){const u=await G({queryClient:e}),c=await C({podcastId:n,queryClient:e});if(u&&c){const g=F(u,p=>{const y=p.pages.at(-1);return y&&y.podcasts.push(c),p});e.setQueryData(t.followed,g)}else await e.invalidateQueries({queryKey:t.followed});await e.invalidateQueries({queryKey:t.recs})}e.setQueryData(t.one(n),u=>({...u,follow:r,followDate:Date.now()})),x({kind:"success",text:l,actions:location?.pathname!==A("/library/podcasts")?[{kind:"tertiary",color:"gray",content:"Go to Library",textColor:w.color.gray600,size:{xsmall:"small",medium:"large"},href:A("/library/podcasts")}]:[]})}}}),D=E({mutationFn:async({podcastId:r})=>{try{const{status:n}=await m.api.v3.podcast.unfollowPodcast({params:{podcastId:Number(r)}});return n!==204}catch{return}},onSuccess:async(r,{podcastId:n})=>{if(P(r)){const l=T?"Unfollowed podcast":`Unfollowed ${i}`;e.setQueryData(t.isFollowing(n),r);const u=await G({queryClient:e}),c=await C({podcastId:n,queryClient:e});u&&c?e.setQueryData(t.followed,g=>g&&F(g,p=>({...p,pages:p?.pages.map(y=>({...y,podcasts:y.podcasts.filter(O=>O.id!==c.id)}))}))):await e.invalidateQueries({queryKey:t.followed}),e.setQueryData(t.one(n),g=>({...g,follow:r})),await e.invalidateQueries({queryKey:t.recs}),x({kind:"success",text:l})}}});return{follow:b.mutate,unfollow:D.mutate}}export{me as a,fe as b,we as u};
//# sourceMappingURL=use-follow-podcast-ziBGefDJ.js.map
