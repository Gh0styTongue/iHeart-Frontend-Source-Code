import{u as H,k as N,a as X}from"./useQuery-BQpwwpuc.js";import{a as q,u as U,m as Z,e as j}from"./amp-client-C2ZZL0mA.js";import{p as s}from"./constants-Culc7LLS.js";import{v as I}from"./text-CLqYBJ6O.js";import{u as J,f as V,g as ee,d as oe,a as L}from"./play-BQDnmloD.js";import{u as Q}from"./useMutation--G9MfniU.js";import{p as v}from"./immer-BQz0PA-9.js";import{r as P}from"./chunk-QMGIS6GS-CFDD2jAw.js";import{l as h}from"./http-error-DJhpcL-Y.js";import{$ as te}from"./index-B6aK0ntB.js";import{d as ae}from"./play-DDtWrYBn.js";import{u as se}from"./is-mobile-BqLxbqHZ.js";import{u as le}from"./useInfiniteQuery-DHZtFi9U.js";import{n as K,y as M,z as x,w as re,x as ie,L as ne,G as C}from"./request-info-Bv3SWXDS.js";import{g as k}from"./use-query-playlist-92VoC3Yg.js";import{R as _}from"./add-to-playlist-sub-menu-Kl5eWOGx.js";function Ae({id:t,userId:l}){return H({queryKey:s.isFollowing({id:t,userId:l}),queryFn:async()=>{const{status:e}=await q.api.v3.collection.getFollowStatus({params:{id:t,userId:l},throwOnErrorStatus:!1});return e===200}}).data??!1}const ue=15;async function D({pageKey:t,userId:l,signal:a}){return await q.api.v3.collection.getCollections({params:{userId:l},query:{limit:ue,includePersonalized:!0,includeIds:!0,...t?{pageKey:t}:{},playlistFilter:"all"},throwOnErrorStatus:!1,fetchOptions:{signal:a}}).then(({status:e,body:o})=>e!==200?{data:[],links:{nextPageKey:void 0}}:o).then(({data:e,links:o})=>({playlists:[...e],nextPageKey:o?.nextPageKey}))}function be({filters:t={followed:!0,personalized:!0,created:!0},signal:l}){const a=U();return le({queryKey:s.followed,queryFn:async({pageParam:e})=>await D({pageKey:e,userId:a.profileId,signal:l}),initialPageParam:void 0,getNextPageParam:e=>e.nextPageKey??void 0,staleTime:Z("30m"),placeholderData:N,select:e=>({...e,pages:e.pages.map(o=>({...o,playlists:[...o.playlists.reduce((c,n)=>(t.personalized&&K.has(n.id)&&c.add(n),t.followed&&String(n.userId)!==String(a.profileId)&&c.add(n),t.created&&String(n.userId)===String(a.profileId)&&!K.has(n.id)&&c.add(n),c),new Set)]}))})})}async function O({queryClient:t,userId:l}){return t.ensureInfiniteQueryData({queryKey:s.followed,queryFn:async({pageParam:a,signal:e})=>await D({pageKey:a,userId:l,signal:e}),initialPageParam:void 0,getNextPageParam:a=>a.nextPageKey??void 0})}function Fe({context:t,isOnProfilePage:l=!1,stationId:a,stationName:e}){const o=X(),c=U(),{onInAppMessageExit:n,onInAppMessageOpen:A}=ae(),p=J(),b=V(),F=ee(),f=j(),E=se(),G=P.useCallback(async i=>{if(i instanceof _){const u=i.ctx,r=i.getMeta("followContext"),y=b({context:u}),g=F({context:u});oe({kind:"info",text:ne,onInAppMessageOpen:A,onInAppMessageExit:n,messageType:x.FOLLOW,userTriggered:!0,pageName:p,location:r??t,...l&&a&&e?{globalStation:{id:a.toString(),name:e}}:{},actions:[{kind:"tertiary",size:{mobile:"small",medium:"large"},color:"gray",textColor:I.color.gray600,href:y.toString(),onPress:()=>{n({messageType:x.FOLLOW,exitType:M.CLICK_SUCCESS,pageName:p,location:r??t})},content:"Log in"},{kind:"tertiary",size:{xsmall:"small",medium:"large"},color:"gray",textColor:I.color.gray600,href:g.toString(),onPress:()=>{n({messageType:x.FOLLOW,exitType:M.CLICK_SUCCESS,pageName:p,location:r??t})},content:"Sign up"}]})}},[t,b,F,l,n,A,p,a,e]),R=P.useCallback(async({id:i,userId:u,followContext:r})=>{if(c.isAnonymous){const y=new _({trigger:ie.FOLLOW,origin:re.LISTEN,pageName:p,location:r??t,...l&&a?{assetId:a.toString()}:{},...l&&e?{assetName:e}:{}});throw y.addMeta("followContext",r),y}else{const{status:y}=await f.api.v3.collection.followPlaylist({params:{id:i,userId:u},throwOnErrorStatus:!1});return y===200}},[f.api.v3.collection,t,l,p,a,e,c.isAnonymous]),$=P.useCallback(async(i,{id:u,userId:r})=>{if(h(i)){const y=globalThis.window?.location.pathname==="/library/playlists/created"||globalThis.window?.location.pathname==="/library/playlists/made-for-you"?" (hidden by your current filter)":"",g=E?`${C.followStationMobile}${y}`:`${e} ${C.followStationDesktop}${y}`;if(o.setQueryData(s.isFollowing({id:u,userId:r}),i),h(o.getQueryData(s.followed))){const w=await O({queryClient:o,userId:c.profileId}),d=await k({id:u,userId:r,queryClient:o,amp:f});if(w&&d){await o.cancelQueries({queryKey:s.followed});const m=v(w,S=>{const T=S.pages.at(-1);return T&&T.playlists.push(d),S});o.setQueryData(s.followed,()=>m),o.setQueryData(s.followed,()=>m)}else await o.invalidateQueries({queryKey:s.followed});await o.invalidateQueries({queryKey:s.recs})}L({kind:"success",text:g,actions:globalThis.window?.location.pathname.startsWith("/library/playlists")?[]:[{kind:"tertiary",color:"gray",content:"Go to Library",textColor:I.color.gray600,size:{xsmall:"small",medium:"large"},href:te("/library/playlists")}]})}},[f,E,o,e,c.profileId]),z=Q({mutationFn:R,onError:G,onSuccess:$}),Y=P.useCallback(async({id:i,userId:u})=>{const{status:r}=await f.api.v3.collection.unfollowPlaylist({params:{id:i,userId:u},throwOnErrorStatus:!1});return r===204},[f.api.v3.collection]),W=P.useCallback(async(i,{id:u,userId:r})=>{if(h(i)){const y=E?C.unfollowStationMobile:`${e} ${C.unfollowStationDesktop}`;o.setQueryData(s.isFollowing({id:u,userId:r}),!i);const g=await O({queryClient:o,userId:c.profileId}),w=await k({id:u,userId:r,queryClient:o,amp:f});g&&w?(await o.cancelQueries({queryKey:s.followed}),o.setQueryData(s.followed,d=>d&&v(d,m=>({...m,pages:m?.pages.map(S=>({...S,playlists:S.playlists.filter(T=>T.id!==w.id)}))})))):await o.invalidateQueries({queryKey:s.followed}),await o.invalidateQueries({queryKey:s.recs}),L({kind:"success",text:y})}},[f,E,o,e,c.profileId]),B=Q({mutationFn:Y,onSuccess:W,onError:G});return{follow:z.mutate,unfollow:B.mutate}}export{Fe as a,be as b,Ae as u};
//# sourceMappingURL=use-follow-playlist-BPFpcBlV.js.map
